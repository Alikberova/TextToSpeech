name: Deployment
run-name: "Deploy to ${{ inputs.environment }}"

permissions:
  contents: read

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        type: choice
        options:
          - staging
          - prod
        default: staging
        
jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    timeout-minutes: 5

    steps:
    - uses: actions/checkout@v6

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_TOKEN }}

    - name: Create .env file
      # redeclare secrets for security reeasons
      env:
        ES_PASS: ${{ secrets.ELASTICSEARCHCONFIG__PASSWORD }}
        GOOGLE_KEY: ${{ secrets.GOOGLECLOUDAPIKEY }}
        NARAKEET_KEY: ${{ secrets.NARAKEETCONFIG__APIKEY }}
        OPENAI_KEY: ${{ secrets.OPENAI_API_KEY }}
        POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        JWT_KEY: ${{ secrets.JWTCONFIG__SYMMETRIC__KEY }}
        EMAIL_FROM: ${{ secrets.EMAILCONFIG__EMAILFROM }}
        EMAIL_PASS: ${{ secrets.EMAILCONFIG__EMAILFROMPASSWORD }}
        EMAIL_TO: ${{ secrets.EMAILCONFIG__EMAILTO }}
      run: |
        echo "IMAGE_TAG_VERSION=${{ inputs.environment }}" > .env
        echo "ASPNETCORE_ENVIRONMENT=$(echo "${{ inputs.environment }}" | sed -E 's/^([a-zA-Z])/\U\1/')" >> .env # capitalize 1st letter
        echo "ANGULAR_ENVIRONMENT=${{ inputs.environment }}" >> .env

        echo "ANGULAR_PORT=${{ vars.ANGULAR_PORT }}" >> .env
        echo "APP_DATA_PATH=${{ vars.APP_DATA_PATH }}" >> .env
        echo "CERTS_PATH=${{ vars.CERTS_PATH }}" >> .env
        echo "ConnectionStrings__Redis=${{ vars.CONNECTIONSTRINGS__REDIS }}" >> .env
        echo "JWTCONFIG__AUDIENCE=${{ vars.JWTCONFIG__AUDIENCE }}" >> .env
        echo "JWTCONFIG__EXPIRATIONMINUTES=${{ vars.JWTCONFIG__EXPIRATIONMINUTES }}" >> .env
        echo "JWTCONFIG__ISSUER=${{ vars.JWTCONFIG__ISSUER }}" >> .env
        echo "NARAKEETCONFIG__APIURL=${{ vars.NARAKEETCONFIG__APIURL }}" >> .env
        echo "ANGULAR_PORT=${{ vars.ANGULAR_PORT }}" >> .env
        echo "POSTGRES_USER=${{ vars.POSTGRES_USER }}" >> .env
        echo "POSTGRES_DB=${{ vars.POSTGRES_DB }}" >> .env
        echo "POSTGRES_EXPOSED_PORT=${{ vars.POSTGRES_EXPOSED_PORT }}" >> .env
        echo "ConnectionStrings__DefaultConnection=User ID=${{ vars.POSTGRES_USER }};Password=$POSTGRES_PASSWORD;Host=db;Port=5432;Database=${{ vars.POSTGRES_DB }};Pooling=true;Include Error Detail=true;" >> .env

        echo "ELASTICSEARCHCONFIG__PASSWORD=$ES_PASS" >> .env
        echo "GOOGLECLOUDAPIKEY=$GOOGLE_KEY" >> .env
        echo "NARAKEETCONFIG__APIKEY=$NARAKEET_KEY" >> .env
        echo "OPENAI_API_KEY=$OPENAI_KEY" >> .env
        echo "POSTGRES_PASSWORD=$POSTGRES_PASSWORD" >> .env
        echo "JWTCONFIG__SYMMETRIC__KEY=$JWT_KEY" >> .env
        echo "EMAILCONFIG__EMAILFROM=$EMAIL_FROM" >> .env
        echo "EMAILCONFIG__EMAILFROMPASSWORD=$EMAIL_PASS" >> .env
        echo "EMAILCONFIG__EMAILTO=$EMAIL_TO" >> .env

    - name: Build and Push Docker Compose services
      run: |
        docker compose build
        docker compose push

    - name: Copy files to server
      uses: appleboy/scp-action@master
      with:
        host: ${{ vars.TTS_SERVER_HOST }}
        username: ${{ vars.TTS_SERVER_USER }}
        key: ${{ secrets.TTS_SERVER_SSH_PRIVATE_KEY }}
        source: docker-compose.yml,.env
        target: ${{ vars.APP_DATA_PATH }}

    - name: Deploy to Server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ vars.TTS_SERVER_HOST }}
        username: ${{ vars.TTS_SERVER_USER }}
        key: ${{ secrets.TTS_SERVER_SSH_PRIVATE_KEY }}
        script: |
          printf '%s' '${{ secrets.DOCKER_TOKEN }}' \
            | docker login -u '${{ secrets.DOCKER_USERNAME }}' --password-stdin
          cd ${{ vars.APP_DATA_PATH }}
          docker network inspect elk >/dev/null 2>&1 || docker network create elk
          docker compose pull
          docker compose down --remove-orphans || true
          docker compose up -d --force-recreate