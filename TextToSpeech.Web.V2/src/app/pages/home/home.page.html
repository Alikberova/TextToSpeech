<section class="hero" aria-label="Text to Speech">
  <h2 class="title">{{ 'home.title' | translate }}</h2>
  <p class="subtitle">{{ 'home.subtitle' | translate }}</p>
</section>

<!-- Form-level error shown only after failed submit -->
@if (submitAttempt() && !formValid()) {
  <div class="form-error" role="alert" aria-live="assertive">
    {{ 'home.form.fixErrors' | translate }}
  </div>
}

<form class="tts-form" (submit)="$event.preventDefault(); submit()" #formEl="ngForm" aria-labelledby="formTitle">
  <h3 id="formTitle" class="sr-only">{{ 'home.form.title' | translate }}</h3>

  <!-- Provider -->
  <mat-form-field appearance="outline" class="field" [attr.aria-invalid]="(providerCtrl.touched || submitAttempt()) && !provider() && 'true'">
    <mat-label>{{ 'home.provider.label' | translate }}</mat-label>
    <mat-select
      #providerCtrl="ngModel"
      #providerEl
      [ngModel]="provider()"
      (ngModelChange)="onProviderChange($event)"
      name="provider"
      required
      panelClass="menu-panel"
      aria-describedby="providerHelp"
    >
      <mat-option [value]="''" disabled>{{ 'home.provider.placeholder' | translate }}</mat-option>
      @for (p of providers; track p.key) {
        <mat-option [value]="p.key">{{ p.label }}</mat-option>
      }
    </mat-select>
    <mat-hint id="providerHelp">{{ 'home.provider.help' | translate }}</mat-hint>
    @if ((providerCtrl.touched || submitAttempt()) && !provider()) {
      <mat-error>{{ 'home.errors.required' | translate }}</mat-error>
    }
  </mat-form-field>

  <!-- Model (conditional) -->
  @if (requiresModel()) {
  <mat-form-field appearance="outline" class="field" [attr.aria-invalid]="(modelCtrl.touched || submitAttempt()) && requiresModel() && !model() && 'true'">
    <mat-label>{{ 'home.model.label' | translate }}</mat-label>
    <mat-select
      #modelCtrl="ngModel"
      #modelEl
      [ngModel]="model()"
      (ngModelChange)="model.set($event)"
      name="model"
      required
      aria-describedby="modelHelp"
    >
      <mat-option [value]="''" disabled>{{ 'home.model.placeholder' | translate }}</mat-option>
      @for (m of modelsForProvider(); track m) {
        <mat-option [value]="m">{{ m }}</mat-option>
      }
    </mat-select>
    <mat-hint id="modelHelp">{{ 'home.model.help' | translate }}</mat-hint>
    @if ((modelCtrl.touched || submitAttempt()) && requiresModel() && !model()) {
      <mat-error>{{ 'home.errors.required' | translate }}</mat-error>
    }
  </mat-form-field>
  }

  <!-- Voice -->
  <mat-form-field appearance="outline" class="field" [attr.aria-invalid]="(voiceCtrl.touched || submitAttempt()) && !voice() && 'true'">
    <mat-label>{{ 'home.voice.label' | translate }}</mat-label>
    <mat-select
      #voiceCtrl="ngModel"
      #voiceEl
      [ngModel]="voice()"
      (ngModelChange)="voice.set($event)"
      name="voice"
      required
      [disabled]="!provider()"
    >
      <mat-option [value]="''" disabled>{{ 'home.voice.placeholder' | translate }}</mat-option>
      @for (v of voicesForProvider(); track v.key) {
        <mat-option [value]="v.key">{{ v.label }}</mat-option>
      }
      <mat-select-trigger>
        {{ selectedVoiceLabel() || ('home.voice.placeholder' | translate) }}
      </mat-select-trigger>
    </mat-select>
    @if ((voiceCtrl.touched || submitAttempt()) && !voice()) {
      <mat-error>{{ 'home.errors.required' | translate }}</mat-error>
    }
  </mat-form-field>
  
  <!-- Language -->
  <mat-form-field appearance="outline" class="field" [attr.aria-invalid]="(languageCtrl.touched || submitAttempt()) && !language() && 'true'">
    <mat-label>{{ 'home.language.label' | translate }}</mat-label>
    <mat-select
      #languageCtrl="ngModel"
      #languageEl
      [ngModel]="language()"
      (ngModelChange)="language.set($event)"
      name="language"
      required
    >
      <mat-option [value]="''" disabled>{{ 'home.language.placeholder' | translate }}</mat-option>
    @for (lang of languages(); track lang.key) {
      <mat-option [value]="lang.key">{{ lang.label | translate }}</mat-option>
    }
    </mat-select>
    @if ((languageCtrl.touched || submitAttempt()) && !language()) {
      <mat-error>{{ 'home.errors.required' | translate }}</mat-error>
    }
  </mat-form-field>

  <!-- File upload with accessible DnD area -->
  <div class="upload">
    <label class="upload-label" [attr.for]="fileInputId">{{ 'home.file.label' | translate }}</label>

    <div
      class="dropzone"
      tabindex="0"
      role="button"
      (keydown.enter)="openFileDialog(fileInput)"
      (keydown.space)="openFileDialog(fileInput)"
      (click)="openFileDialog(fileInput)"
      (drop)="onDrop($event)"
      (dragover)="onDragOver($event)"
      [attr.aria-describedby]="'fileHelp'"
      [attr.aria-invalid]="(fileTouched() || submitAttempt()) && !file() && 'true'"
    >
      <mat-icon aria-hidden="true">upload_file</mat-icon>
      <div class="dz-text">
        <strong>{{ 'home.file.drop' | translate }}</strong>
        <span>{{ 'home.file.or' | translate }}</span>
        <span class="link">{{ 'home.file.browse' | translate }}</span>
        <small id="fileHelp">{{ 'home.file.help' | translate }}</small>
      </div>
    </div>

    <input
      #fileInput
      [id]="fileInputId"
      class="sr-only"
      type="file"
      (change)="onFileSelected(fileInput)"
      accept=".txt,.pdf,.epub"
      aria-hidden="true"
    />

    @if (file(); as f) {
      <div class="file-info">
        <mat-icon aria-hidden="true">description</mat-icon>
        <span class="name">{{ f.name }}</span>
        <button type="button" mat-button color="primary" (click)="removeFile()">{{ 'home.file.remove' | translate }}</button>
      </div>
    }
    @if ((fileTouched() || submitAttempt()) && !file()) {
      <mat-error>{{ 'home.errors.required' | translate }}</mat-error>
    }

    <!-- ARIA live region for upload announcements -->
    <div aria-live="polite" class="visually-hidden">{{ statusMessage() }}</div>
  </div>

  <!-- Speed slider -->
  <div class="field slider-field">
    <label [attr.for]="speedInputId">{{ 'home.speed.label' | translate }}</label>
    <mat-slider min="0.5" max="2.0" step="0.1" [displayWith]="formatSpeed">
      <input matSliderThumb [id]="speedInputId" [value]="speed()" (valueChange)="speed.set($event)" />
    </mat-slider>
    <div class="hint">{{ 'home.speed.help' | translate:{ min: '0.5', max: '2.0', step: '0.1', value: speed().toFixed(1) } }}</div>
  </div>

  <!-- Sample text and play -->
  <mat-form-field appearance="outline" class="field text-field">
    <mat-label>{{ 'home.sample.label' | translate }}</mat-label>
    <textarea
      matInput
      rows="3"
      [ngModel]="sampleText()"
      (ngModelChange)="sampleText.set($event)"
      [ngModelOptions]="{ standalone: true }"
      placeholder="{{ 'home.sample.placeholder' | translate }}"
    ></textarea>
    <button mat-icon-button matSuffix type="button" [attr.aria-label]="'home.sample.play' | translate" (click)="playOrToggleSample()">
      <mat-icon>{{ samplePlaying() ? 'pause' : 'play_arrow' }}</mat-icon>
    </button>
    <mat-hint>{{ 'home.sample.help' | translate }}</mat-hint>
  </mat-form-field>

  <!-- Actions -->
  <div class="actions">
    <button type="submit" mat-raised-button color="primary">{{ 'home.actions.submit' | translate }}</button>
    <button type="button" mat-stroked-button color="primary" (click)="download()" [disabled]="!hasResult()" [class.hidden]="!hasResult()">{{ 'home.actions.download' | translate }}</button>
    <button type="button" mat-button (click)="clear()">{{ 'home.actions.clear' | translate }}</button>
  </div>

  <!-- Progress -->
  @if (status() !== 'Idle') {
    <div class="progress">
      <mat-progress-bar [mode]="status() === 'Processing' || status() === 'Created' ? 'determinate' : 'determinate'" [value]="progress()"></mat-progress-bar>
      <div class="progress-text">
        <span>
          {{
            status() === 'Created' ? ('home.progress.created' | translate) :
            status() === 'Processing' ? ('home.progress.processing' | translate) :
            status() === 'Completed' ? ('home.progress.completed' | translate) :
            status() === 'Failed' ? ('home.progress.failed' | translate) :
            ('home.progress.canceled' | translate)
          }}
        </span>
        @if (status() === 'Processing') {
          <span>{{ progress() }}%</span>
        }
        @if (status() === 'Processing') {
          <button type="button" mat-button (click)="cancel()">{{ 'home.actions.cancel' | translate }}</button>
        }
      </div>
    </div>
  }

</form>
