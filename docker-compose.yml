services:
  webserver:
    image: nginx:latest
    ports:
      - 80:80
      - 443:443
    restart: always
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/:ro
      - ./certbot/www:/var/www/certbot/:ro
      - ./certbot/conf/:/etc/nginx/ssl/:ro
  certbot:
    image: certbot/certbot:latest
    volumes:
      - ./certbot/www/:/var/www/certbot/:rw
      - ./certbot/conf/:/etc/letsencrypt/:rw

  booktoaudioapi:
    build:
      context: .
      dockerfile: docker/api.Dockerfile
      cache_from:
        - alikberova/booktoaudio.api:${IMAGE_TAG_VERSION}
      args:
        API_NAME: BookToAudio.Api
    image: alikberova/booktoaudio.api:${IMAGE_TAG_VERSION}
    env_file: .env
    container_name: booktoaudio_api
    ports:
      - "7057:7057"

  booktoaudioweb:
    build:
      context: BookToAudio.Web
      dockerfile: ../docker/web.Dockerfile
      cache_from:
        - alikberova/booktoaudio.web:${IMAGE_TAG_VERSION}
    image: alikberova/booktoaudio.web:${IMAGE_TAG_VERSION}
    environment:
      ENVIRONMENT: ${ENVIRONMENT}
    container_name: booktoaudio_web
    ports:
      - "${ANGULAR_PORT}:${ANGULAR_PORT}" # for tests ANGULAR_PORT should be the same as in selenium tests; 443 for prod
    volumes:
      - ./BookToAudio.Web/entrypoint.sh:/entrypoint.sh